class String
  ISO_3166_COUNTRIES = 
    {"AD" => ["ANDORRA"], 
     "AE" => ["UNITED ARAB EMIRATES"], 
     "AF" => ["AFGHANISTAN"], 
     "AG" => ["ANTIGUA AND BARBUDA"], 
     "AI" => ["ANGUILLA"], 
     "AL" => ["ALBANIA"], 
     "AM" => ["ARMENIA"], 
     "AN" => ["NETHERLANDS ANTILLES"], 
     "AO" => ["ANGOLA"], 
     "AQ" => ["ANTARCTICA"], 
     "AR" => ["ARGENTINA"], 
     "AS" => ["AMERICAN SAMOA"], 
     "AT" => ["AUSTRIA"], 
     "AU" => ["AUSTRALIA"], 
     "AW" => ["ARUBA"], 
     "AX" => ["ÅLAND ISLANDS",
              "ALAND ISLANDS"], 
     "AZ" => ["AZERBAIJAN"], 
     "BA" => ["BOSNIA AND HERZEGOVINA"], 
     "BB" => ["BARBADOS"], 
     "BD" => ["BANGLADESH"], 
     "BE" => ["BELGIUM"], 
     "BF" => ["BURKINA FASO"], 
     "BG" => ["BULGARIA"], 
     "BH" => ["BAHRAIN"], 
     "BI" => ["BURUNDI"], 
     "BJ" => ["BENIN"], 
     "BL" => ["SAINT BARTHÉLEMY",
              "SAINT BARTHELEMY"], 
     "BM" => ["BERMUDA"], 
     "BN" => ["BRUNEI DARUSSALAM"], 
     "BO" => ["BOLIVIA"], 
     "BR" => ["BRAZIL"], 
     "BS" => ["BAHAMAS"], 
     "BT" => ["BHUTAN"], 
     "BV" => ["BOUVET ISLAND"], 
     "BW" => ["BOTSWANA"], 
     "BY" => ["BELARUS"], 
     "BZ" => ["BELIZE"], 
     "CA" => ["CANADA"], 
     "CC" => ["COCOS (KEELING) ISLANDS",
              "COCOS ISLANDS"], 
     "CD" => ["CONGO, THE DEMOCRATIC REPUBLIC OF THE",
              "THE DEMOCRATIC REPUBLIC OF THE CONGO"], 
     "CF" => ["CENTRAL AFRICAN REPUBLIC",
              "CENTRAL AFRICAN"], 
     "CG" => ["CONGO"], 
     "CH" => ["SWITZERLAND"], 
     "CI" => ["CÔTE D'IVOIRE",
              "COTE D'IVOIRE"], 
     "CK" => ["COOK ISLANDS"], 
     "CL" => ["CHILE"], 
     "CM" => ["CAMEROON"], 
     "CN" => ["CHINA"], 
     "CO" => ["COLOMBIA"], 
     "CR" => ["COSTA RICA"], 
     "CU" => ["CUBA"], 
     "CV" => ["CAPE VERDE"], 
     "CX" => ["CHRISTMAS ISLAND"], 
     "CY" => ["CYPRUS"], 
     "CZ" => ["CZECH REPUBLIC",
              "CZECH"], 
     "DE" => ["GERMANY"], 
     "DJ" => ["DJIBOUTI"], 
     "DK" => ["DENMARK"], 
     "DM" => ["DOMINICA"], 
     "DO" => ["DOMINICAN REPUBLIC",
              "DOMINICAN"], 
     "DZ" => ["ALGERIA"], 
     "EC" => ["ECUADOR"], 
     "EE" => ["ESTONIA"], 
     "EG" => ["EGYPT"], 
     "EH" => ["WESTERN SAHARA"], 
     "ER" => ["ERITREA"], 
     "ES" => ["SPAIN"], 
     "ET" => ["ETHIOPIA"], 
     "FI" => ["FINLAND"], 
     "FJ" => ["FIJI"], 
     "FK" => ["FALKLAND ISLANDS (MALVINAS)"], 
     "FM" => ["MICRONESIA, FEDERATED STATES OF"], 
     "FO" => ["FAROE ISLANDS"], 
     "FR" => ["FRANCE"], 
     "GA" => ["GABON"], 
     "GB" => ["UNITED KINGDOM"], 
     "GD" => ["GRENADA"], 
     "GE" => ["GEORGIA"], 
     "GF" => ["FRENCH GUIANA"], 
     "GG" => ["GUERNSEY"], 
     "GH" => ["GHANA"], 
     "GI" => ["GIBRALTAR"], 
     "GL" => ["GREENLAND"], 
     "GM" => ["GAMBIA"], 
     "GN" => ["GUINEA"], 
     "GP" => ["GUADELOUPE"], 
     "GQ" => ["EQUATORIAL GUINEA"], 
     "GR" => ["GREECE"], 
     "GS" => ["SOUTH GEORGIA AND THE SOUTH SANDWICH ISLANDS"], 
     "GT" => ["GUATEMALA"], 
     "GU" => ["GUAM"], 
     "GW" => ["GUINEA-BISSAU"], 
     "GY" => ["GUYANA"], 
     "HK" => ["HONG KONG"], 
     "HM" => ["HEARD ISLAND AND MCDONALD ISLANDS"], 
     "HN" => ["HONDURAS"], 
     "HR" => ["CROATIA"], 
     "HT" => ["HAITI"], 
     "HU" => ["HUNGARY"], 
     "ID" => ["INDONESIA"], 
     "IE" => ["IRELAND"], 
     "IL" => ["ISRAEL"], 
     "IM" => ["ISLE OF MAN"], 
     "IN" => ["INDIA"], 
     "IO" => ["BRITISH INDIAN OCEAN TERRITORY"], 
     "IQ" => ["IRAQ"], 
     "IR" => ["IRAN, ISLAMIC REPUBLIC OF",
              "ISLAMIC REPUBLIC OF IRAN",
              "IRAN"], 
     "IS" => ["ICELAND"], 
     "IT" => ["ITALY"], 
     "JE" => ["JERSEY"], 
     "JM" => ["JAMAICA"], 
     "JO" => ["JORDAN"], 
     "JP" => ["JAPAN"], 
     "KE" => ["KENYA"], 
     "KG" => ["KYRGYZSTAN"], 
     "KH" => ["CAMBODIA"], 
     "KI" => ["KIRIBATI"], 
     "KM" => ["COMOROS"], 
     "KN" => ["SAINT KITTS AND NEVIS"], 
     "KP" => ["KOREA, DEMOCRATIC PEOPLE'S REPUBLIC OF",
              "DEMOCRATIC PEOPLE'S REPUBLIC OF KOREA"], 
     "KR" => ["KOREA, REPUBLIC OF",
              "REPUBLIC OF KOREA"], 
     "KW" => ["KUWAIT"], 
     "KY" => ["CAYMAN ISLANDS"], 
     "KZ" => ["KAZAKHSTAN"], 
     "LA" => ["LAO PEOPLE'S DEMOCRATIC REPUBLIC",
              "PEOPLE'S DEMOCRATIC REPUBLIC OF LAO",
              "LAO"], 
     "LB" => ["LEBANON"], 
     "LC" => ["SAINT LUCIA"], 
     "LI" => ["LIECHTENSTEIN"], 
     "LK" => ["SRI LANKA"], 
     "LR" => ["LIBERIA"], 
     "LS" => ["LESOTHO"], 
     "LT" => ["LITHUANIA"], 
     "LU" => ["LUXEMBOURG"], 
     "LV" => ["LATVIA"], 
     "LY" => ["LIBYAN ARAB JAMAHIRIYA"], 
     "MA" => ["MOROCCO"], 
     "MC" => ["MONACO"], 
     "MD" => ["MOLDOVA, REPUBLIC OF",
              "REPUBLIC OF MOLDOVA",
              "MOLDOVA"], 
     "ME" => ["MONTENEGRO"], 
     "MF" => ["SAINT MARTIN"], 
     "MG" => ["MADAGASCAR"], 
     "MH" => ["MARSHALL ISLANDS"], 
     "MK" => ["MACEDONIA, THE FORMER YUGOSLAV REPUBLIC OF",
              "THE FORMER YUGOSLAV REPUBLIC OF MACEDONIA",
              "MACEDONIA"], 
     "ML" => ["MALI"], 
     "MM" => ["MYANMAR"], 
     "MN" => ["MONGOLIA"], 
     "MO" => ["MACAO"], 
     "MP" => ["NORTHERN MARIANA ISLANDS"], 
     "MQ" => ["MARTINIQUE"], 
     "MR" => ["MAURITANIA"], 
     "MS" => ["MONTSERRAT"], 
     "MT" => ["MALTA"], 
     "MU" => ["MAURITIUS"], 
     "MV" => ["MALDIVES"], 
     "MW" => ["MALAWI"], 
     "MX" => ["MEXICO"], 
     "MY" => ["MALAYSIA"], 
     "MZ" => ["MOZAMBIQUE"], 
     "NA" => ["NAMIBIA"], 
     "NC" => ["NEW CALEDONIA"], 
     "NE" => ["NIGER"], 
     "NF" => ["NORFOLK ISLAND"], 
     "NG" => ["NIGERIA"], 
     "NI" => ["NICARAGUA"], 
     "NL" => ["NETHERLANDS"], 
     "NO" => ["NORWAY"], 
     "NP" => ["NEPAL"], 
     "NR" => ["NAURU"], 
     "NU" => ["NIUE"], 
     "NZ" => ["NEW ZEALAND"], 
     "OM" => ["OMAN"], 
     "PA" => ["PANAMA"], 
     "PE" => ["PERU"], 
     "PF" => ["FRENCH POLYNESIA"], 
     "PG" => ["PAPUA NEW GUINEA"], 
     "PH" => ["PHILIPPINES"], 
     "PK" => ["PAKISTAN"], 
     "PL" => ["POLAND"], 
     "PM" => ["SAINT PIERRE AND MIQUELON"], 
     "PN" => ["PITCAIRN"], 
     "PR" => ["PUERTO RICO"], 
     "PS" => ["PALESTINIAN TERRITORY, OCCUPIED",
              "PALESTINE"], 
     "PT" => ["PORTUGAL"], 
     "PW" => ["PALAU"], 
     "PY" => ["PARAGUAY"], 
     "QA" => ["QATAR"], 
     "RE" => ["RÉUNION",
              "REUNION"], 
     "RO" => ["ROMANIA"], 
     "RS" => ["SERBIA"], 
     "RU" => ["RUSSIAN FEDERATION"], 
     "RW" => ["RWANDA"], 
     "SA" => ["SAUDI ARABIA"], 
     "SB" => ["SOLOMON ISLANDS"], 
     "SC" => ["SEYCHELLES"], 
     "SD" => ["SUDAN"], 
     "SE" => ["SWEDEN"], 
     "SG" => ["SINGAPORE"], 
     "SH" => ["SAINT HELENA"], 
     "SI" => ["SLOVENIA"], 
     "SJ" => ["SVALBARD AND JAN MAYEN"], 
     "SK" => ["SLOVAKIA"], 
     "SL" => ["SIERRA LEONE"], 
     "SM" => ["SAN MARINO"], 
     "SN" => ["SENEGAL"], 
     "SO" => ["SOMALIA"], 
     "SR" => ["SURINAME"], 
     "ST" => ["SAO TOME AND PRINCIPE"], 
     "SV" => ["EL SALVADOR"], 
     "SY" => ["SYRIAN ARAB REPUBLIC",
              "SYRIAN"], 
     "SZ" => ["SWAZILAND"], 
     "TC" => ["TURKS AND CAICOS ISLANDS"], 
     "TD" => ["CHAD"], 
     "TF" => ["FRENCH SOUTHERN TERRITORIES"], 
     "TG" => ["TOGO"], 
     "TH" => ["THAILAND"], 
     "TJ" => ["TAJIKISTAN"], 
     "TK" => ["TOKELAU"], 
     "TL" => ["TIMOR-LESTE",
              "TIMOR LESTE"], 
     "TM" => ["TURKMENISTAN"], 
     "TN" => ["TUNISIA"], 
     "TO" => ["TONGA"], 
     "TR" => ["TURKEY"], 
     "TT" => ["TRINIDAD AND TOBAGO"], 
     "TV" => ["TUVALU"], 
     "TW" => ["TAIWAN, PROVINCE OF CHINA",
              "TAIWAN"], 
     "TZ" => ["TANZANIA, UNITED REPUBLIC OF",
              "TANZANIA"], 
     "UA" => ["UKRAINE"], 
     "UG" => ["UGANDA"], 
     "UM" => ["UNITED STATES MINOR OUTLYING ISLANDS"], 
     "US" => ["UNITED STATES"], 
     "UY" => ["URUGUAY"], 
     "UZ" => ["UZBEKISTAN"], 
     "VA" => ["VATICAN CITY STATE",
              "VATICAN CITY",
              "HOLY SEE"], 
     "VC" => ["SAINT VINCENT AND THE GRENADINES",
              "SAINT VINCENT"], 
     "VE" => ["VENEZUELA"], 
     "VG" => ["VIRGIN ISLANDS, BRITISH",
              "BRITISH VIRGIN ISLANDS"], 
     "VI" => ["VIRGIN ISLANDS, U.S.",
               "U.S. VIRGIN ISLANDS"], 
     "VN" => ["VIET NAM"], 
     "VU" => ["VANUATU"], 
     "WF" => ["WALLIS AND FUTUNA"], 
     "WS" => ["SAMOA"], 
     "YE" => ["YEMEN"], 
     "YT" => ["MAYOTTE"], 
     "ZA" => ["SOUTH AFRICA"], 
     "ZM" => ["ZAMBIA"], 
     "ZW" => ["ZIMBABWE"]}
    
  
  public # PUBLIC instance methods
  
  # Returns the first char (means true) if there is at least 1 char (no blank string)
  def any?
    self[0]
  end
  
  # Returns true if the string is blank (no char)
  def blank?
    !self[0]
  end
  
  # Returns true if the first char of the string
  def capitalized?
    (self[0] >= 65 && self[0] <= 90) if self.any? # 65 => A, 90 => Z
  end
  
  # Deserializes a string serialized with Array#serialize (or other)
  # i.e. "|a|1| b| |".deserialize # => ["", "a", "1", " b", " ", ""]
  # 
  # Takes four options (it will run on the array after splitting the string):
  # * :strip: if true, calls strip method (removes whitespace before and after the text string) for every chunk of text (default to false)
  # * :force_nil: if true, sets to nil every blank chunk of text (default to false)
  # * :compact: if true, removes all nil objects (default to false)
  # * :uniq: if true removes all duplicated elements (default to false)
  #
  def deserialize(separator='|', options={})
    options = {:strip     => false,
               :force_nil => false,
               :compact   => false,
               :uniq      => false}.merge(options) # merges options
    array = self.split(separator.to_s, self.size).map do |chunk| # splits string into chunks
      chunk.strip! if options[:strip] # calls strips method for every chunk of text (if options[:strip] is true)
      (options[:force_nil] && chunk.blank?) ? nil : chunk # sets nil object if a chunk of text is blank (if options[:force_nil] is true)
    end
    array.compact! if options[:compact] # removes nil objects (if options[:compact] is true)
    options[:uniq] ? array.uniq : array # removes all duplicated elements (if options[:uniq] is true)
  end
  
  # Returns how many times the string matched the given pattern
  def how_many(pattern)
    self.scan(pattern).length
  end
  
  # Used to indent Here-Documents
  #
  # i.e.  str = <<end_of_string.margin
  #              |  aaa
  #              |a
  #              |  aa
  #       end_of_string
  #
  # => "  aaa\na  \naa\n"
  #
  def margin
    self.replace((self.deserialize("\n", :strip => true).map {|line| line.sub('|','')}).serialize("\n"))
  end
  
  # Returns a value in cents for a given string number
  # i.e. 100,3 
  #   => 10030
  #
  def to_cents
    value = self.dup
    value.strip! # removes whitespace from borders
    dots   = value.how_many('.')
    commas = value.how_many(',') # commas is not mathematically correct
    case dots
    when 0
      value.gsub!(',','') if (commas > 1)
    when 1
      if commas == 1
        (value.rindex('.') > value.rindex(',')) ? value.gsub!(',','') : value.gsub!('.','')
      else
        value.gsub!(',','') unless commas.zero?
      end
    else # more then one
      (commas > 1) ? value.gsub!(',','') : value.gsub!('.', '')
    end
    value.gsub!(',', '.')
    (value.to_f * 100).round
  end
  
  def to_iso_3166(long_to_short=true)
    string = self.dup.strip.upcase
    if long_to_short
      countries = ISO_3166_COUNTRIES.invert
      countries.each do |long, short|
        long.each {|country| return short if(country == string)}
      end
    else # short to long
      return ISO_3166_COUNTRIES[string].first
    end
  end
end # String